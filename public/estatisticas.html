<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estatísticas - Vibrações 48ª EAE Online</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f4f6f9; 
            margin: 0; 
            padding: 25px; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        h1 { color: #333; margin: 0; }
        .btn-voltar {
            padding: 10px 20px;
            background-color: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
        }
        .cards-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .card { 
            background-color: white; 
            padding: 25px; 
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            text-align: center; 
        }
        .card .numero { 
            font-size: 2.5em; 
            font-weight: bold; 
            color: #007bff; 
            margin: 0; 
        }
        .card .legenda { 
            font-size: 1.1em; 
            color: #666; 
            margin-top: 5px; 
        }
        .grafico-container { 
            background-color: white; 
            padding: 25px; 
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
        }
        h2 { color: #444; margin-top: 0; }
    </style>
</head>
<body>
    <div id="main-content" class="container" style="display: none;">
        <div class="header-area">
            <h1>Estatísticas do Trabalho</h1>
            <a href="/dashboard.html" class="btn-voltar">⬅ Voltar ao Dashboard</a>
        </div>

        <div class="cards-container">
            <div class="card">
                <p id="total-ativos" class="numero">...</p>
                <p class="legenda">Nomes Ativos no Painel</p>
            </div>
            <div class="card">
                <p id="pedidos-hoje" class="numero">...</p>
                <p class="legenda">Pedidos Recebidos Hoje</p>
            </div>
        </div>

        <div class="grafico-container">
            <h2>Pedidos por Mês (Últimos 6 Meses)</h2>
            <canvas id="grafico-mensal"></canvas>
        </div>
    </div>

    <script type="module">
        // Importação das bibliotecas do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        // Importação da proteção de rota que criamos no auth.js
        import { protegerPagina } from '/auth.js';

        // Configuração oficial do projeto vibracoes-cede
        const firebaseConfig = {
            apiKey: "AIzaSyBuYdERX224x0dzWtFH0mi__oVH3DxsmP0",
            authDomain: "vibracoes-cede.firebaseapp.com",
            projectId: "vibracoes-cede",
            storageBucket: "vibracoes-cede.firebasestorage.app",
            messagingSenderId: "1081610853181",
            appId: "1:1081610853181:web:b10eb65f1506d141684354"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- LÓGICA DE PROTEÇÃO E CARREGAMENTO ---
        protegerPagina()
            .then(user => {
                // Se o usuário está logado, mostra a página e carrega os dados
                document.getElementById('main-content').style.display = 'block';
                carregarEstatisticas();
            })
            .catch(error => {
                // Se não estiver logado, redireciona para o login
                console.error("Acesso negado. Redirecionando...");
                window.location.href = '/login.html';
            });

        async function carregarEstatisticas() {
            try {
                // Busca o documento de resumo gerado pelo robô das 03:00
                const docRef = doc(db, "estatisticas", "resumo");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const dados = docSnap.data();

                    // Atualiza os números nos cartões do topo
                    document.getElementById('total-ativos').textContent = dados.totalAtivos || 0;
                    document.getElementById('pedidos-hoje').textContent = dados.pedidosHoje || 0;
                    
                    // Prepara os dados do gráfico (meses e quantidades)
                    const labels = dados.pedidosPorMes.map(item => item.mes);
                    const dataPoints = dados.pedidosPorMes.map(item => item.total);

                    // Renderiza o gráfico de barras usando Chart.js
                    new Chart(document.getElementById('grafico-mensal'), {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Total de Pedidos',
                                data: dataPoints,
                                backgroundColor: 'rgba(0, 123, 255, 0.5)',
                                borderColor: 'rgba(0, 123, 255, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: { 
                            responsive: true,
                            scales: { 
                                y: { beginAtZero: true, ticks: { stepSize: 1 } } 
                            } 
                        }
                    });

                } else {
                    // Caso o robô ainda não tenha rodado nenhuma vez
                    console.log("O documento de resumo ainda não existe no Firestore.");
                    document.getElementById('total-ativos').textContent = "0";
                    document.getElementById('pedidos-hoje').textContent = "0";
                }
            } catch (error) {
                console.error("Erro técnico ao carregar estatísticas:", error);
                alert("Erro ao carregar dados. Verifique sua conexão ou permissões.");
            }
        }
    </script>
</body>
</html>